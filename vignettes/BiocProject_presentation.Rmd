---
title: "BiocProject Usage"
author: "Michal Stolarczyk"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

The `BiocProject` class formalizes a way how the metadata are presented within the [Bioconductor](https://www.bioconductor.org/) classes. It uses the generic R package [pepr](http://code.databio.org/pepr/) that provides an interface to the Portable Encapsulated Project (PEP) to enclose the metadata to the original Bioconductor objects. 

See the [pepkit.github.io](https://pepkit.github.io/) website to learn more about the PEP environment.

# Installation

The `BiocProject` package is currently availavble only via GitHub install. To get the most recent version of the packae run:

```
devtools::install_github(repo = 'pepkit/pepr',ref = 'dev')
```

to install developement version of `pepr` and 

```
devtools::install_github(repo = 'pepkit/BiocProject',ref = 'dev')
```

to install development version of `BiocProject`

# Usage

In order to use the `BiocProject` package you need two things:

1. a PEP (see [this website](https://pepkit.github.io/docs/simple_example/) for creation instructions and/or use the example provided with this package as guideline)

2. a function that processes your data

# Code

Get paths to the files used in this vignette

```{r echo=T,message=FALSE}
library(BiocProject)
ProjectConfig = system.file(
  "extdata",
  "example_peps-master",
  "example_BiocProject",
  "project_config.yaml",
  package = "BiocProject"
)

processFunction =  system.file(
  "extdata",
  "example_peps-master",
  "example_BiocProject",
  "parseEncodeRegions.R",
  package = "BiocProject"
)
```
Read the `parseEncodeRegions` function into the R environment
```{r}
source(processFunction)
```


## There are multiple options to read the data into the `BiocProject` objects

- *Option 1*: you can specify the function name in the PEP config file in the key value pair presented below and set the `autoLoad` parameter of the `BiocProject` constructor to `TRUE`

```
bioconductor:
  read_fun_name: parseEncodeRegions
```

OR

```
bioconductor:
  read_fun_name: package::function
```

The constructor will look for the function in the R enviornment and it it's not there, it will try to get it from the specified namespace (if `::` or `:::` is detected): `getFromNamespace("package","function")`

- *Option 2*: you can specify the file that the function is saved in in the PEP config file in the key value pair presented below and set the `autoLoad` parameter of the `BiocProject` constructor to `TRUE`

```
bioconductor:
  read_fun_path: $CODE/myFun.R
```

The construcor will source this file and run the function that is implemented there. The names of the function and file do not have to match.

- *Option 3*: or you provide a lambda function in the `func` parameter in the `BiocProject` constructor. This option is given absolute priority.


- *Option 4*: set the `autoLoad` parameter of the `BiocProject` constructor to `FALSE`. The constructor will create an empty `BiocProject` object (with no data read)


## Data loading in practice

### *Options 1 and 2*: Automatically load the data

**When the function is present in the environment**
```{r}
source(processFunction)
bp1 = BiocProject(file=ProjectConfig,autoLoad = TRUE)
#Inspect it
bp1
```

**When the function is removed from the environment**
```{r}
rm(parseEncodeRegions)
bp2 = BiocProject(file=ProjectConfig,autoLoad = TRUE)
#Inspect it
bp2
```


The function that was used to process the data [`parseEncodeRegions.R`](https://raw.githubusercontent.com/pepkit/example_peps/master/example_BiocProject/parseEncodeRegions.R) (click to view it) was specified in the [PEP config file](https://raw.githubusercontent.com/pepkit/example_peps/master/example_BiocProject/project_config.yaml).

### *Option 3*: Use lambda functio to load the data

```{r}
bp3 = BiocProject(file=ProjectConfig, func=function(x){parseEncodeRegions(x)})
#Inspect it
bp3
```

### *Option 4*: Do not load the data

```{r}
bp4 = BiocProject(file=ProjectConfig,autoLoad = FALSE)
#Inspect it
bp4
```

## What if your function requires additional arguments?

### *Option 1*: Use the `funcArgs` argument

Use `funcArgs` to provide a list of named arguments for your function when using `autoLoad=TRUE`, like:

```{r}
ProjectConfigArgs = system.file(
  "extdata",
  "example_peps-master",
  "example_BiocProject",
  "project_config_args.yaml",
  package = "BiocProject"
)

processFunctionArgs =  system.file(
  "extdata",
  "example_peps-master",
  "example_BiocProject",
  "parseEncodeRegions_args.R",
  package = "BiocProject"
)
source(processFunctionArgs)
bp5 =  BiocProject(file=ProjectConfigArgs, autoLoad=TRUE,funcArgs = list(arg1="TEST1",arg2="TEST2"))
```

The strings `"TEST1"` and `"TEST2"` which were passed as argments were printed as it was implemented in the `parseEncodeRegions_args.R` function.

The function that was used to process the data and test the addtional args passing [`parseEncodeRegions_args.R`](https://raw.githubusercontent.com/pepkit/example_peps/master/example_BiocProject/parseEncodeRegions_args.R) (click to view it) was specified in the [PEP config file](https://raw.githubusercontent.com/pepkit/example_peps/master/example_BiocProject/project_config_args.yaml).

### *Option 2*: Provide parameters directly to the lambda function 

```{r}
source(processFunctionArgs)
is.function(parseEncodeRegions_args)==TRUE
parseEncodeRegions_args
bp6 = BiocProject(file=ProjectConfigArgs, func=function(x){parseEncodeRegions_args(x,"TEST1","TEST2")})
#Inspect it
bp6
```

## Interact with `BiocProject` object

Apply the [`pepr::Project`-related methods](http://code.databio.org/pepr/reference/index.html)
```{r}
samples(bp6)
config(bp6)
```
Apply the `list`-related methods
```{r}
names(bp6) = c("myDataset")
names(bp6)
bp6[[1]]
```

